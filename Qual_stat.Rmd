---
title: "fisher's or chisquare"
author: "Ramon A. Zegpi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

The code below need to be executed in total or nothing will work BEWARE

```{r echo = T, warning=FALSE, message=FALSE}
if (!require('writexl')) install.packages("writexl")
if (!require('reticulate')) install.packages("reticulate")
if (!require('ggplot2')) install.packages("ggplot2")
if (!require('readxl')) install.packages("readxl")
if (!require('wesanderson')) install.packages("wesanderson")
if (!require('scales')) install.packages("scales")
if (!require('ggstatsplot')) install.packages("ggstatsplot")
if (!require('ggsignif')) install.packages("ggsignif")
if (!require('olsrr')) install.packages("olsrr")
if (!require('hexbin')) install.packages("hexbin")

library(writexl)
library(ggplot2)
library(tools)
library(reticulate)
library(readxl)
library(wesanderson)
library(scales)
library(ggstatsplot)
library(ggsignif)
library(olsrr)
library(hexbin)
```


Choose yor excel (xlsx) file with the right format (data organized well) in it

```{r}

file1 <- file.choose(new=FALSE)
if(file_ext(file1)!="xlsx"){
 stop("Wrong file extension") #if file extension is not xlsx, the program stops.
} 

dataColumns <- read_excel(file1, sheet = 1)


```


Define your colors


```{r}
#names(wes_palettes)
# [1] "BottleRocket1"  "BottleRocket2"  "Rushmore1"      "Rushmore"       "Royal1"         "Royal2"         "Zissou1"        "Darjeeling1"    "Darjeeling2"    **"Chevalier1"**    
#[11] "FantasticFox1"  "Moonrise1"      *"Moonrise2"*      "Moonrise3"      "Cavalcanti1"    "GrandBudapest1" "GrandBudapest2" "IsleofDogs1"    *"IsleofDogs2"*  

colorPalette <- "GrandBudapest1" #change the number with the number of groups

#hist(rnorm(100000), col=wes_palette(colorPalette, n = length(unique(unlist(dataColumns$Groups))), type = "continuous"))
if(length(unique(unlist(dataColumns$Values)))<2){
  wes_palette(colorPalette, n = 2, type = "continuous")
}else{
  wes_palette(colorPalette, n = length(unique(unlist(dataColumns$Values))), type = "continuous")
}

```

Fisher's or Chi-square

```{r}

#using factors, determine the pairwise comparisons
significativo <- FALSE
pvalue2 <- 1
if(length(unique(unlist(dataColumns$Groups)))==2){
    if(min(table(dataColumns[,c(1,2)]))<5){
      fishertest <- fisher.test(x = factor(dataColumns$Groups), y = dataColumns$Values)
      pvalue2 <- fishertest$p.value
      
      
      fishertest
    }else{
      chitest <- chisq.test(x = factor(dataColumns$Groups), y = dataColumns$Values)
      pvalue2 <- chitest$p.value
      
      
      chitest
    }
}else{
  if(length(unique(unlist(dataColumns$Values)))>2){
    significativo <- TRUE
    }
}
if(pvalue2<0.05) anotamelo <- "*"
if(pvalue2<0.01) anotamelo <- "**"
if(pvalue2<0.001) anotamelo <- "***"

```
Plot

```{r echo = FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 8}


pairwisevals <- as.data.frame(table(dataColumns[,c(1,2)]))

primaryplot <- ggbarstats(
  data = dataColumns,
  x = Values,
  #y = DPI,
  y = Groups,
  #conf.level = confidence,
  results.subtitle = FALSE, 
  title = dataColumns$title, 
  subtitle = dataColumns$subtitle,
  xlab = dataColumns$labelx,
  legend.title = dataColumns$legend,
  caption = dataColumns$Caption,
  proportion.test = FALSE
  
  #ggplot.component = ggplot2::
  )+
   ggplot2::theme(text=element_text(family="sans"), 
       plot.title = element_text(hjust = 0.5, face = "bold", margin = margin(t = 0, r = 0, b = 5, l = 0, unit = "pt")), 
       plot.subtitle = element_text(hjust = 0.5, margin = margin(t = 0, r = 0, b = 20, l = 0, unit = "pt")), 
       plot.caption = element_text(hjust = 0), 
       panel.background = element_rect(fill = "white", color = "lightgray"), 
       panel.grid.major.y = element_line(color = "gray95", linetype = "solid"), 
       panel.grid.minor = element_line(color = "White", linetype = "solid"), 
       axis.text.x.bottom = element_text(face="plain", color="Black", size=11, angle=0, margin = margin(t = 5, r = 0, b = 0, l = 0, unit = "pt")),
       axis.text.x.top = element_text(face="plain", color="Black", size=11, angle=45, margin = margin(t = 0, r = 0, b = 5, l = 0, unit = "pt")),
       #axis.text.y = element_text(face="plain", color="Black", size=11, angle=0, margin = margin(t = 0, r = 5, b = 0, l = 0, unit = "pt")),
       axis.text.y = element_blank(),
       axis.title.x = element_text(face = "plain", margin = margin(t = 10, r = 0, b = 0, l = 0, unit = "pt")), 
       axis.title.x.top = element_text(face = "plain", margin = margin(t = 0, r = 0, b = 10, l = 0, unit = "pt")), 
       axis.title.y = element_text(face = "plain", margin = margin(t = 0, r = 5, b = 0, l = 0, unit = "pt")), 
       axis.ticks = element_blank(), #remove ticks
       legend.position = "right",
       legend.title = element_blank(),
       )+
        #geom_line(size = 0.5)+
        scale_fill_manual(values = wes_palette(colorPalette, length(unique(unlist(dataColumns$Values))), type = "continuous"))+
        scale_color_manual(values = "Black")
        


#thickness of border of bar plot, may need to be undone. Careful with shapes.
#primaryplot$plot_env$plotBar$layers[[1]]$geom$default_aes$size <- 0.25


pvals <- extract_stats(primaryplot)

pvals <- pvals$one_sample_data$p.value[[1]]
#if(pvals<0.05){
  
 # primaryplot#+
   #ggplot2::annotate(geom = "text", x= (length(unique(unlist(dataColumns$Groups)))+1)/2, y = 1.05, label = paste("p-value ≈ ", round(pvals, digits = 6), sep=""))
#}else{
 # primaryplot  
#}
if(significativo){
  primaryplot
}else{
  if(pvalue2<0.05){
      primaryplot <- primaryplot+
    ggsignif::geom_signif(
      comparisons=list(c(unique(dataColumns$Groups))),
      #map_signif_level = TRUE,
      #test = NULL,
      #show.legend = FALSE,
      annotations = anotamelo,
      y_position = -3.8, #need work!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      #na.rm = TRUE,
      #step_increase = 0.2, 
      tip_length = 0
                )
  }

  
  primaryplot
}
  
```


```{r echo = FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 7}
#save the plot
ggsave(plot = primaryplot, paste(file1, "_", gsub(Sys.time(), pattern = ":", replacement = "-"),"_plot.png"), width = 4, height = 6, units = "in")

```






DO NOT USE



```{r}
secondaryplot <- grouped_ggbarstats(
  data = dataColumns,
  x = Values,
  y = DPI,
  grouping.var = Groups2,
  #conf.level = confidence,
  results.subtitle = FALSE, 
  title.text = dataColumns$title, 
  subtitle = dataColumns$subtitle,
  xlab = dataColumns$labelx,
  legend.title = dataColumns$legend,
  caption = dataColumns$Caption,
  proportion.test = FALSE,
  plotgrid.args = list(nrow=2)
  
  #ggplot.component = ggplot2::
  )+
   ggplot2::theme(text=element_text(family="sans"), 
       plot.title = element_text(hjust = 0.5, face = "bold", margin = margin(t = 0, r = 0, b = 5, l = 0, unit = "pt")), 
       plot.subtitle = element_text(hjust = 0.5, margin = margin(t = 0, r = 0, b = 20, l = 0, unit = "pt")), 
       plot.caption = element_text(hjust = 0), 
       panel.background = element_rect(fill = "white", color = "lightgray"), 
       panel.grid.major.y = element_line(color = "gray95", linetype = "solid"), 
       panel.grid.minor = element_line(color = "White", linetype = "solid"), 
       axis.text.x.bottom = element_text(face="plain", color="Black", size=11, angle=0, margin = margin(t = 5, r = 0, b = 0, l = 0, unit = "pt")),
       axis.text.x.top = element_text(face="plain", color="Black", size=11, angle=45, margin = margin(t = 0, r = 0, b = 5, l = 0, unit = "pt")),
       #axis.text.y = element_text(face="plain", color="Black", size=11, angle=0, margin = margin(t = 0, r = 5, b = 0, l = 0, unit = "pt")),
       axis.text.y = element_blank(),
       axis.title.x = element_text(face = "plain", margin = margin(t = 10, r = 0, b = 0, l = 0, unit = "pt")), 
       axis.title.x.top = element_text(face = "plain", margin = margin(t = 0, r = 0, b = 10, l = 0, unit = "pt")), 
       axis.title.y = element_text(face = "plain", margin = margin(t = 0, r = 5, b = 0, l = 0, unit = "pt")), 
       axis.ticks = element_blank(), #remove ticks
       legend.position = "right",
       legend.title = element_blank(),
       )+
        #geom_line(size = 0.5)+
        scale_fill_manual(values = wes_palette(colorPalette, length(unique(unlist(dataColumns$Values))), type = "continuous"))+
        scale_color_manual(values = "Black")
        


#thickness of border of bar plot, may need to be undone. Careful with shapes.
#primaryplot$plot_env$plotBar$layers[[1]]$geom$default_aes$size <- 0.25


pvals <- extract_stats(primaryplot)

pvals <- pvals$one_sample_data$p.value[[1]]
#if(pvals<0.05){
  
 # primaryplot#+
   #ggplot2::annotate(geom = "text", x= (length(unique(unlist(dataColumns$Groups)))+1)/2, y = 1.05, label = paste("p-value ≈ ", round(pvals, digits = 6), sep=""))
#}else{
 # primaryplot  
#}
if(significativo){
  primaryplot
}else{
  if(pvalue2<0.05){
      primaryplot <- primaryplot+
    ggsignif::geom_signif(
      comparisons=list(c(unique(dataColumns$Groups))),
      #map_signif_level = TRUE,
      #test = NULL,
      #show.legend = FALSE,
      annotations = anotamelo,
      y_position = -3.4, #need work!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      #na.rm = TRUE,
      #step_increase = 0.2, 
      tip_length = 0
                )
  }

  
  primaryplot
}
  
```

